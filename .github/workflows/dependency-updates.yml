name: Update Dependencies

on:
  push:
    branches: [ main ]
    paths:
      - '**/*.cpp'
      - '**/*.hpp'
      - 'CMakeLists.txt'
      - 'vcpkg.json'
      - '.github/workflows/dependency-updates.yml'
  pull_request:
  workflow_dispatch:

jobs:
  build-and-report:
    runs-on: windows-latest

    # Run commands inside MSYS2 MINGW64 so MinGW toolchain is on PATH
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up MSYS2 (MINGW64)
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          # IMPORTANT: install **MinGW** variants of cmake and make, not MSYS ones.
          install: >-
            git
            jq
            mingw-w64-x86_64-toolchain
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-make

      - name: Verify MinGW environment
        run: |
          echo "MSYSTEM=$MSYSTEM"
          which gcc && gcc --version
          which g++ && g++ --version
          which cmake && cmake --version
          which mingw32-make && mingw32-make --version

      - name: Set up vcpkg (manifest mode)
        # Use POSIX bootstrap and keep paths consistent for MSYS2
        run: |
          git clone --depth=1 https://github.com/microsoft/vcpkg "$GITHUB_WORKSPACE/vcpkg"
          "$GITHUB_WORKSPACE/vcpkg/bootstrap-vcpkg.sh"

          VCPKG_ROOT_POSIX=$(cygpath -u "$GITHUB_WORKSPACE/vcpkg")
          VCPKG_ROOT_WIN=$(cygpath -m "$GITHUB_WORKSPACE/vcpkg")

          echo "VCPKG_ROOT=$VCPKG_ROOT_WIN" >> $GITHUB_ENV
          echo "VCPKG_ROOT_POSIX=$VCPKG_ROOT_POSIX" >> $GITHUB_ENV

          # Keep triplets on MinGW to avoid x64-windows detection
          echo "VCPKG_DEFAULT_TRIPLET=x64-mingw-dynamic" >> $GITHUB_ENV
          echo "VCPKG_HOST_TRIPLET=x64-mingw-dynamic" >> $GITHUB_ENV
          echo "VCPKG_FORCE_SYSTEM_BINARIES=1" >> $GITHUB_ENV
          echo "VCPKG_FEATURE_FLAGS=manifests,versions" >> $GITHUB_ENV

      # Do NOT pre-run `vcpkg install` here; let CMake + toolchain resolve deps.

      - name: Configure (CMake + MinGW Makefiles + vcpkg)
        id: cmake_configure
        run: |
          CMAKE_BIN=$(which cmake)
          echo "Using CMake at: $CMAKE_BIN"

          cmake -S . -B build -G "MinGW Makefiles" \
            -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT_POSIX/scripts/buildsystems/vcpkg.cmake" \
            -DVCPKG_TARGET_TRIPLET=x64-mingw-dynamic \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_SH=CMAKE_SH-NOTFOUND

          echo "Selected C/CXX compilers:" && grep -E "^CMAKE_(C|CXX)_COMPILER:FILEPATH" build/CMakeCache.txt || true

      - name: Build
        if: steps.cmake_configure.outcome == 'success'
        run: cmake --build build --config Release -- -j2

      # ---- Dependency report section ----
      - name: Generate vcpkg baseline/upgrade report
        id: dep_report
        run: |
          set -eo pipefail
          echo "## Dependency Report" >> "$GITHUB_STEP_SUMMARY"

          if [ -f vcpkg.json ]; then
            BASELINE=$(jq -r '."builtin-baseline" // empty' vcpkg.json)
            if [ -n "$BASELINE" ]; then
              echo "**Manifest builtin-baseline:** \`$BASELINE\`" >> "$GITHUB_STEP_SUMMARY"
            fi
          fi

          echo "### Proposed baseline updates (dry run)" >> "$GITHUB_STEP_SUMMARY"
          { "$GITHUB_WORKSPACE/vcpkg/vcpkg" x-update-baseline --dry-run --x-manifest-root=. || true; } | tee vcpkg-baseline-dryrun.txt
          if [ -s vcpkg-baseline-dryrun.txt ]; then
            echo '\n````\n' >> "$GITHUB_STEP_SUMMARY" && cat vcpkg-baseline-dryrun.txt >> "$GITHUB_STEP_SUMMARY" && echo '\n````\n' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No baseline changes suggested (or command not supported by current vcpkg)." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "### Upgradeable packages (classic listing)" >> "$GITHUB_STEP_SUMMARY"
          { "$GITHUB_WORKSPACE/vcpkg/vcpkg" upgrade || true; } | tee vcpkg-upgrade.txt
          if [ -s vcpkg-upgrade.txt ]; then
            echo '\n````\n' >> "$GITHUB_STEP_SUMMARY" && cat vcpkg-upgrade.txt >> "$GITHUB_STEP_SUMMARY" && echo '\n````\n' >> "$GITHUB_STEP_SUMMARY"
          else
            echo "No upgradeable packages detected." >> "$GITHUB_STEP_SUMMARY"
          fi

          echo "### CMake configure status" >> "$GITHUB_STEP_SUMMARY"
          if [ "${{ steps.cmake_configure.outcome }}" != "success" ]; then
            echo "CMake configure failed; surfacing logs:" >> "$GITHUB_STEP_SUMMARY"
            if [ -f build/CMakeFiles/CMakeError.log ]; then
              tail -n 200 build/CMakeFiles/CMakeError.log | tee cmake-error-tail.txt
              echo '\n````\n' >> "$GITHUB_STEP_SUMMARY" && cat cmake-error-tail.txt >> "$GITHUB_STEP_SUMMARY" && echo '\n````\n' >> "$GITHUB_STEP_SUMMARY"
            fi
            if [ -f build/CMakeFiles/CMakeOutput.log ]; then
              tail -n 200 build/CMakeFiles/CMakeOutput.log | tee cmake-output-tail.txt
              echo '\n````\n' >> "$GITHUB_STEP_SUMMARY" && cat cmake-output-tail.txt >> "$GITHUB_STEP_SUMMARY" && echo '\n````\n' >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "CMake configure succeeded; no missing packages detected by CMake." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload dependency artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dependency-report
          path: |
            vcpkg-baseline-dryrun.txt
            vcpkg-upgrade.txt
            cmake-error-tail.txt
            cmake-output-tail.txt
          if-no-files-found: ignore
