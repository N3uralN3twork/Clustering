name: Clustering Benchmark

on:
  # Manual trigger with configurable parameters
  workflow_dispatch:
    inputs:
      n_samples:
        description: 'Number of samples'
        required: false
        default: '1000'
        type: string
      n_features:
        description: 'Number of features'
        required: false
        default: '4'
        type: string

  # Automatic trigger on push to main
  push:
    branches:
      - main

env:
  # Use default small dataset for automatic runs
  DEFAULT_N_SAMPLES: 1000
  DEFAULT_N_FEATURES: 4

  # vcpkg configuration
  VCPKG_BINARY_SOURCES: 'clear;x-gha,readwrite'

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'  # Latest stable release

      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_CACHE_URL', process.env.ACTIONS_CACHE_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            curl \
            zip \
            unzip \
            tar

      - name: Set benchmark parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "n_samples=${{ github.event.inputs.n_samples }}" >> $GITHUB_OUTPUT
            echo "n_features=${{ github.event.inputs.n_features }}" >> $GITHUB_OUTPUT
          else
            echo "n_samples=${{ env.DEFAULT_N_SAMPLES }}" >> $GITHUB_OUTPUT
            echo "n_features=${{ env.DEFAULT_N_FEATURES }}" >> $GITHUB_OUTPUT
          fi

      - name: Display benchmark configuration
        run: |
          echo "::group::Benchmark Configuration"
          echo "Trigger: ${{ github.event_name }}"
          echo "N_SAMPLES: ${{ steps.params.outputs.n_samples }}"
          echo "N_FEATURES: ${{ steps.params.outputs.n_features }}"
          echo "::endgroup::"

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DBUILD_TESTS=OFF \
            -DBUILD_BENCHMARKS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -G Ninja

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Run benchmark
        run: |
          echo "::group::Benchmark Results"
          ./build/Clustering \
            --n-samples ${{ steps.params.outputs.n_samples }} \
            --n-features ${{ steps.params.outputs.n_features }}
          echo "::endgroup::"

      - name: Summary
        run: |
          echo "### Benchmark Completed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Samples: ${{ steps.params.outputs.n_samples }}" >> $GITHUB_STEP_SUMMARY
          echo "- Features: ${{ steps.params.outputs.n_features }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_View the full benchmark output in the workflow logs above._" >> $GITHUB_STEP_SUMMARY