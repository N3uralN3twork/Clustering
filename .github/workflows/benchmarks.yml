name: Clustering Benchmark

on:
  workflow_dispatch:
    inputs:
      n_samples:
        description: 'Number of samples'
        required: false
        default: '1000'
        type: string
      n_features:
        description: 'Number of features'
        required: false
        default: '4'
        type: string

  push:
    branches:
      - master

env:
  DEFAULT_N_SAMPLES: 1000
  DEFAULT_N_FEATURES: 4

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            ninja-build \
            git

      - name: Setup vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          ./vcpkg/bootstrap-vcpkg.sh
          echo "VCPKG_ROOT=${{ github.workspace }}/vcpkg" >> $GITHUB_ENV

      - name: Install dependencies via vcpkg
        run: |
          ${{ github.workspace }}/vcpkg/vcpkg install

      - name: Set benchmark parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "n_samples=${{ github.event.inputs.n_samples }}" >> $GITHUB_OUTPUT
            echo "n_features=${{ github.event.inputs.n_features }}" >> $GITHUB_OUTPUT
          else
            echo "n_samples=${{ env.DEFAULT_N_SAMPLES }}" >> $GITHUB_OUTPUT
            echo "n_features=${{ env.DEFAULT_N_FEATURES }}" >> $GITHUB_OUTPUT
          fi

      - name: Display benchmark configuration
        run: |
          echo "::group::Benchmark Configuration"
          echo "Trigger: ${{ github.event_name }}"
          echo "N_SAMPLES: ${{ steps.params.outputs.n_samples }}"
          echo "N_FEATURES: ${{ steps.params.outputs.n_features }}"
          echo "::endgroup::"

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_TOOLCHAIN_FILE=${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake \
            -DBUILD_TESTS=OFF \
            -DBUILD_BENCHMARKS=OFF \
            -DBUILD_EXAMPLES=OFF \
            -G Ninja

      - name: Build
        run: cmake --build build --config Release --parallel

      - name: Run benchmark
        run: |
          echo "::group::Benchmark Results"
          ./build/Clustering \
            --n-samples ${{ steps.params.outputs.n_samples }} \
            --n-features ${{ steps.params.outputs.n_features }} \
            | tee benchmark_results.txt
          echo "::endgroup::"

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: benchmark-results-${{ steps.params.outputs.n_samples }}s-${{ steps.params.outputs.n_features }}f
          path: benchmark_results.txt
          retention-days: 30

      - name: Summary
        run: |
          echo "### Benchmark Completed âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- Samples: ${{ steps.params.outputs.n_samples }}" >> $GITHUB_STEP_SUMMARY
          echo "- Features: ${{ steps.params.outputs.n_features }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat benchmark_results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY